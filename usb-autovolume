#!/bin/bash
# Configuration
readonly DEFAULT_VOLUME=85                   # Default volume to set for USB soundcard

# Enable strict error handling
set -euo pipefail

# Function to handle errors
# Logs an error message with the line number and error code, then exits
error_handler() {
    local line_no=$1
    local error_code=$2
    log_message "Error (code: ${error_code}) occurred on line ${line_no}"
    exit ${error_code}
}

# Trap any error and pass it to the error handler
trap 'error_handler ${LINENO} $?' ERR

# Log function to write messages to a log file
# This appends messages with a timestamp to /tmp/autosink-usb.log
log_message() {
    echo "$1"
    echo "$(date) - $1" >> /tmp/autovolume-usb.log
}

# Sleep for a brief moment to ensure the device is fully initialized
sleep 1

# List sound devices and filter out USB audio devices
aplay -l | grep -i "usb" | while read -r line; do
    # Extract the soundcard index (e.g., "card 1")
    card_index=$(echo "$line" | grep -oP 'card \K\d+')

    # Output the soundcard index for debugging
    log_message "USB audio device detected. Soundcard index: $card_index"

    # Adjust the volume of the detected soundcard to 85% using amixer
    amixer -c "$card_index" sset 'Master' 85%

    # You can also specify 'PCM' or another control if 'Master' doesn't exist for your device:
    # amixer -c "$card_index" sset 'PCM' 85%

    log_message "Volume set to 85% on card $card_index"
done
