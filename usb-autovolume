#!/bin/bash
# Configuration
readonly DEFAULT_VOLUME=85                   # Default volume to set for USB soundcard

# Enable strict error handling
set -euo pipefail

# Function to handle errors
# Logs an error message with the line number and error code, then exits
error_handler() {
    local line_no=$1
    local error_code=$2
    log_message "Error (code: ${error_code}) occurred on line ${line_no}"
    exit ${error_code}
}

# Trap any error and pass it to the error handler
trap 'error_handler ${LINENO} $?' ERR

# Log function to write messages to a log file
# This appends messages with a timestamp to /tmp/autosink-usb.log
log_message() {
    echo "$1"
    echo "$(date) - $1" >> /tmp/autovolume-usb.log
}

# Sleep for a brief moment to ensure the device is fully initialized
sleep 1

log_message "$(aplay -l)"  # Log the detected soundcards

# Check for USB soundcard
USB_CARD=$(aplay -l | grep "card" | grep -i "usb" | awk '{print $2}' | cut -d':' -f1 | head -n 1)
if [ -n "$USB_CARD" ]; then
  # Output the soundcard index for debugging
  log_message "USB audio device detected. Soundcard index: $USB_CARD"

  # Adjust the volume of the detected soundcard to 85% using amixer
  amixer -c "$USB_CARD" sset 'Master' 85%

  # You can also specify 'PCM' or another control if 'Master' doesn't exist for your device:
  # amixer -c "$USB_CARD" sset 'PCM' 85%

  log_message "Volume set to 85% on card $USB_CARD"
fi